(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{285:function(t,a,s){t.exports=s.p+"assets/img/01-01.93445e45.jpg"},298:function(t,a,s){"use strict";s.r(a);var n=s(16),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("p"),n("div",{staticClass:"table-of-contents"},[n("ul",[n("li",[n("a",{attrs:{href:"#背景"}},[t._v("背景")]),n("ul",[n("li",[n("a",{attrs:{href:"#问题"}},[t._v("问题")])]),n("li",[n("a",{attrs:{href:"#解决"}},[t._v("解决")])])])]),n("li",[n("a",{attrs:{href:"#实现"}},[t._v("实现")]),n("ul",[n("li",[n("a",{attrs:{href:"#_1-下载与引包"}},[t._v("1. 下载与引包")])]),n("li",[n("a",{attrs:{href:"#_2-使用步骤"}},[t._v("2. 使用步骤")])])])]),n("li",[n("a",{attrs:{href:"#爬坑"}},[t._v("爬坑")]),n("ul",[n("li",[n("a",{attrs:{href:"#page-evaluate-的传参问题"}},[t._v("page.evaluate 的传参问题")])]),n("li",[n("a",{attrs:{href:"#元素操作问题"}},[t._v("元素操作问题")])])])])])]),n("p"),t._v(" "),n("h2",{attrs:{id:"背景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[t._v("#")]),t._v(" 背景")]),t._v(" "),n("p",[t._v("这两天对爬虫开始感兴趣，最开始是源于天涯的一个房价神贴，盖了上万层，追着读了好久。天涯网页端的“只看楼主”需要会员，手机端可以“只看楼主”，但是体验不太好，记录也不方便，于是决定把楼主发言单独爬下来，既可以保存，也可以检索。")]),t._v(" "),n("p",[t._v("最开始想法很简单，对每一页进行元素检索，发帖人与楼主名字匹配的，就把里面的content拷出来。")]),t._v(" "),n("p",[t._v("首先在网上找到的工具是"),n("code",[t._v("cheerio")]),t._v("插件，它在读取网站之后，将网站内容存下来，通过元素选择器进行内容选取。在使用递归后，还能解决翻页问题。")]),t._v(" "),n("p",[t._v("事实上也确实如此，通过简单几步操作，就把楼主的发言保存了下来，也让我对爬虫产生了兴趣。")]),t._v(" "),n("h3",{attrs:{id:"问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[t._v("#")]),t._v(" 问题")]),t._v(" "),n("p",[n("code",[t._v("cheerio")]),t._v("确实简单好用，在应对简单静态网页时没有问题。但对付具备一定反爬机制的网站就无能为力了。比如"),n("code",[t._v("cheerio")]),t._v("解决翻页问题，靠的是动态修改"),n("code",[t._v("url")]),t._v("链接。但是有的网站，比如我最爱的"),n("strong",[t._v("煎蛋")]),t._v("，它的网页链接页码是乱码，就没办法实现自动翻页。再比如有的房产网站，在罗列在售资源时，为了用户体验，使用了"),n("strong",[t._v("懒加载")]),t._v("，只有将页面滚动到底部后，才能触发加载。")]),t._v(" "),n("p",[t._v("以上种种实际上就是"),n("code",[t._v("cheerio")]),t._v("对于网页操作是无能为力的。")]),t._v(" "),n("h3",{attrs:{id:"解决"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决"}},[t._v("#")]),t._v(" 解决")]),t._v(" "),n("p",[t._v("在网上查找对付懒加载的方法时，发现了"),n("code",[t._v("puppeteer")]),t._v("插件。谷歌浏览器在17年自行开发了Chrome Headless特性，并与之同时推出了puppeteer，本质上就是一个不含界面的浏览器，有点像电脑的终端，所有操作都通过代码进行操作。")]),t._v(" "),n("p",[t._v("这样，我们就可以在对网站进行检索之前，操作指定元素滚动到底部，以触发更多信息。或者在需要翻页的时候，操作代码对翻页按钮进行点击，然后对翻页后的页面进行相关处理。")]),t._v(" "),n("h2",{attrs:{id:"实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实现"}},[t._v("#")]),t._v(" 实现")]),t._v(" "),n("h3",{attrs:{id:"_1-下载与引包"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-下载与引包"}},[t._v("#")]),t._v(" 1. 下载与引包")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 下载")]),t._v("\nnpm i puppeteer\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 引包")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" puppeteer "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'puppeteer'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("h3",{attrs:{id:"_2-使用步骤"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-使用步骤"}},[t._v("#")]),t._v(" 2. 使用步骤")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将整个操作放置在一个闭包的异步函数中，以便于进行异步操作")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 使用puppetee插件启动一个浏览器，并开启一个新页面")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" brower "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" puppeteer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("launch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        args"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--no-sandbox'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        dumpio"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        headless"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 默认为true，设为false时，可以显示可视化浏览器界面")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" page "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" brower"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("newPage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 开启一个新页面")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 打开指定网页")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" page"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("goto")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://jandan.net/ooxx'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        waitUntil"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'networkidle2'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 网络空闲说明已加载完毕")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 对动态网站进行自动化操作，这一步是其精髓所在")]),t._v("\n    \n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 由于我们监控的是动态网页，刚打开网页时，所需元素也许还未出现，所以需要进行监听，例如“下一页按钮”")]),t._v("\n    \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" page"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("waitForSelector")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'a.previous-comment-page'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 括号内是元素选择器")]),t._v("\n    \n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 当下一页按钮出现时，模拟点击")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" page"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("click")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'a.previous-comment-page'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    \n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 4. 这时我们可以执行爬取我们需要的数据了，我们可以去审查页面的dom结果，来循环遍历这些数据。")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// page.evaluate() 为在浏览器中执行函数，相当于在控制台中执行函数，返回一个 Promise")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" result "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" page"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("evaluate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 拿到页面上的jQuery")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" $ "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在这里进行熟悉的 DOM 操作")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Do something")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 5. 关闭浏览器，在console里面打印我们需要的数据")]),t._v("\n    brower"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("close")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 6. 对结果进行处理")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("h2",{attrs:{id:"爬坑"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#爬坑"}},[t._v("#")]),t._v(" 爬坑")]),t._v(" "),n("h3",{attrs:{id:"page-evaluate-的传参问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#page-evaluate-的传参问题"}},[t._v("#")]),t._v(" page.evaluate 的传参问题")]),t._v(" "),n("p",[t._v("因为打开的这个 page 只是一个木偶，并不是真正的浏览器页面，所以在这个页面上的操作与一般页面上的操作有差异。")]),t._v(" "),n("p",[n("img",{attrs:{src:s(285),alt:"image"}})]),t._v(" "),n("p",[t._v("官方文档里说，这个参数是这样的。在实际使用中，可以传一个字符串变量，但是到更复杂一点的，比如‘fs’，自定义外部函数时，都无法读取。")]),t._v(" "),n("p",[t._v("这也是我建议在第6步，对页面操作完成后，统一对结果进行处理。（主要是因为我没有解决这个问题，所以认怂绕开走了……）")]),t._v(" "),n("h3",{attrs:{id:"元素操作问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#元素操作问题"}},[t._v("#")]),t._v(" 元素操作问题")]),t._v(" "),n("p",[n("code",[t._v("puppeteer")]),t._v("中，最重要的函数执行和要素选择都与一般浏览器上操作有些区别，这里有些坑要爬，现在我也说不清楚。")])])}),[],!1,null,null,null);a.default=e.exports}}]);